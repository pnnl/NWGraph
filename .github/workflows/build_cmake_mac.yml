# Workflow to configure with cmake and build with gcc

name: Build with gcc (Mac)

on:
  push:
    branches: [ master, sc_release ]
  workflow_dispatch:

#  pull_request:
#    branches:
#      - '*'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:

    runs-on: macos-latest

    steps:

    - name: Checkout NWgr
      uses: actions/checkout@v4
      with:
        path: NWgr

    - name: Install dependencies
      run: |
        brew update
        brew install gcc tbb

    - name: cmake
      run: |
        cd NWgr
        mkdir build
        cd build
        # Find the highest gcc version installed by homebrew
        GCC_VERSION=$(ls /opt/homebrew/bin/g++-* 2>/dev/null | grep -o '[0-9]*$' | sort -n | tail -1)
        if [ -z "$GCC_VERSION" ]; then
          GCC_VERSION=$(ls /usr/local/bin/g++-* 2>/dev/null | grep -o '[0-9]*$' | sort -n | tail -1)
        fi
        echo "Using g++-$GCC_VERSION"
        cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_CXX_COMPILER=g++-$GCC_VERSION -DNWGRAPH_BUILD_DOCS=OFF -DNWGRAPH_BUILD_TESTS=ON

    - name: make
      run: |
        cd NWgr/build
        # Limit parallelism to avoid potential OOM issues
        make -j4 -k

    - name: run_test
      run: |
        cd NWgr/build
        make test
