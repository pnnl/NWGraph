name: gh-pages

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and deploy documentation

    steps:
      - name: Checkout NWgraph
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz
          pip install sphinx sphinx_rtd_theme breathe exhale sphinxcontrib-bibtex

      - name: Install TBB
        run: |
          wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB
          sudo apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB
          rm GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB
          sudo add-apt-repository "deb https://apt.repos.intel.com/oneapi all main"
          sudo apt-get update
          sudo apt-get install -y intel-oneapi-tbb-devel

      - name: Build compile_commands.json
        run: |
          mkdir -p build
          cd build
          export TBBROOT=/opt/intel/oneapi/tbb/latest
          cmake .. -DCMAKE_CXX_COMPILER=g++ -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DNWGRAPH_BUILD_DOCS=OFF

      - name: Build documentation
        run: |
          cd doc-src/sphinx
          make html
          mkdir -p ../../docs
          cp -r _build/html/* ../../docs/
          touch ../../docs/.nojekyll

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/master'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          force_orphan: true
